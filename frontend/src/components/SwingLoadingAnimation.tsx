"use client";

import { useEffect, useState } from "react";

interface SwingLoadingAnimationProps {
  phase: "uploading" | "analyzing";
  analysisError?: string | null;
}

/**
 * Timed pipeline steps — approximate durations based on real backend timing.
 * Steps auto-advance on a timer to give the user a sense of progress.
 * The last step stays active until the real response arrives.
 */
const PIPELINE_STEPS = [
  { label: "Uploading video",          delayMs: 0 },
  { label: "Extracting body landmarks", delayMs: 3000 },
  { label: "Detecting swing phases",    delayMs: 12000 },
  { label: "Calculating angles",        delayMs: 16000 },
  { label: "Comparing to reference",    delayMs: 18000 },
  { label: "Generating feedback",       delayMs: 20000 },
];

export default function SwingLoadingAnimation({
  phase,
  analysisError,
}: SwingLoadingAnimationProps) {
  const [activeStep, setActiveStep] = useState(0);

  // When phase changes to "analyzing", jump to step 1 and start
  // the timed progress for the remaining pipeline steps
  useEffect(() => {
    if (phase !== "analyzing") return;

    setActiveStep(1); // "Extracting body landmarks"

    // Schedule remaining steps relative to when analysis begins
    const timers = PIPELINE_STEPS.slice(2).map((step, i) => {
      // delayMs is relative to mount, but we want relative to analysis start
      // step 2 starts at 12s from mount → 9s after analysis begins (upload ~3s)
      const relativeDelay = step.delayMs - PIPELINE_STEPS[1].delayMs;
      return setTimeout(() => setActiveStep(i + 2), relativeDelay);
    });

    return () => timers.forEach((t) => clearTimeout(t));
  }, [phase]);

  return (
    <div className="rounded-xl border-2 border-pastel-yellow/30 bg-pastel-yellow/5 p-8 text-center">
      {/* SVG silhouette container — cross-fade between 4 poses */}
      <div className="relative w-48 h-52 mx-auto mb-6">
        {/* Subtle glow behind silhouette */}
        <div className="glow-pulse absolute inset-8 bg-pastel-yellow rounded-full blur-3xl" />

        {/* Pose 1: Address */}
        <svg
          viewBox="0 0 90 199"
          className="swing-pose-1 absolute inset-0 w-full h-full"
          preserveAspectRatio="xMidYMid meet"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            d="M31.2341 0.112675C44.084 -0.988532 42.0553 6.15174 45.8142 14.1118C45.5392 16.3259 44.9095 18.7725 44.4059 20.9684C52.3096 22.3243 59.5065 23.4035 65.1038 29.4825C66.2309 33.4136 67.6783 51.2195 65.8599 53.7588C59.2662 62.9675 63.0333 66.6422 61.2087 76.8497C62.8258 79.2911 65.3523 82.8917 65.8177 85.7977C66.5317 90.5252 67.4446 94.9939 68.7992 99.5844C71.582 109.015 72.1664 118.841 73.3442 128.535C73.8073 132.347 76.4057 136.071 77.0268 140.13C79.1116 153.756 80.8739 167.384 83.4578 180.926C84.3383 185.569 90.9125 188.086 88.6056 192.24C84.6309 196.122 75.1998 191.754 71.2009 189.197C71.1595 188.133 71.2289 184.907 71.0791 184.252C69.8966 178.168 66.9959 171.76 65.8435 165.709C63.2931 152.32 60.7795 139.523 56.1962 126.611C54.3988 121.547 51.5489 116.642 50.2895 111.463C49.4523 116.573 46.9234 118.665 46.4521 123.378C45.245 135.44 44.1952 147.54 43.2643 159.627C42.2714 172.525 40.1417 185.639 40.1596 198.571C35.6703 198.729 33.6042 198.844 29.2085 197.647C28.754 197.276 28.3041 196.82 27.8758 196.411C27.1138 192.238 35.4195 191.251 38.4223 191.189C39.2381 184.345 39.5623 177.791 40.1705 170.959C41.8079 153.657 43.1816 136.331 44.2912 118.987C39.5604 115.515 39.5373 111.733 38.4598 106.05C36.2582 113.532 32.2843 120.452 30.3789 128.61C28.7173 134.864 24.4851 144.169 24.5514 150.752C24.6571 161.258 16.0753 181.206 16.469 189.898L12.2227 193.469C-9.78453 196.897 4.50032 186.598 5.21271 180.111L7.66045 158.403C8.00416 155.209 8.38843 149.093 8.98573 146.235C10.414 139.958 12.9273 134.063 13.8184 127.641C14.915 121.741 14.4071 115.744 15.3399 109.837C16.6648 101.448 17.8017 92.4644 19.3833 84.1301C19.64 82.7762 21.4397 79.4791 22.1052 78.1701C20.9524 74.3596 21.9355 73.1765 20.9044 69.7543C20.2817 67.6883 17.4138 64.9285 16.483 63.1032C14.3634 58.947 11.4108 47.3025 11.6886 43.0132C12.2016 35.0906 21.5333 29.6339 26.9769 25.2877C25.139 23.0016 25.1971 24.7469 24.1285 20.966C21.8513 12.9085 21.0605 2.66411 31.2341 0.112675Z"
            fill="currentColor"
          />
        </svg>

        {/* Pose 2: Top of backswing */}
        <svg
          viewBox="0 0 93 218"
          className="swing-pose-2 absolute inset-0 w-full h-full"
          preserveAspectRatio="xMidYMid meet"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            d="M49.7027 0H52.8432C43.8662 6.95572 34.46 13.471 25.5337 20.5136C22.8807 22.6084 19.8611 25.1908 16.9819 26.8882C18.0548 31.4797 17.727 33.1758 16.0299 37.4283C16.424 40.1239 16.7751 41.6264 17.4657 44.2317C21.6167 47.2681 25.6624 50.3829 29.8876 53.3327C35.0335 56.9274 38.2014 53.1727 45.0912 51.6455C46.8585 41.7045 49.7222 31.1346 62.386 36.5304C70.3292 40.9764 65.9519 49.8284 64.8673 55.9039C64.5122 57.895 68.398 68.8634 68.4565 72.2459C68.6399 83.5537 63.494 93.231 65.1754 104.462C66.6892 114.601 68.0898 124.688 69.5957 134.827C70.3019 140.03 71.1017 145.252 71.7064 150.469C72.7597 159.589 77.3399 167.596 79.7198 176.392L85.4665 197.51C86.6642 201.793 86.3092 203.992 89.2391 207.473C90.8543 209.393 93.277 212.844 91.9467 215.399C91.3069 215.989 91.0259 216.087 90.1793 216.175C82.1347 217.011 82.6341 216.205 76.9927 211.858L76.3178 205.955C72.077 202.479 71.0821 195.213 69.3382 190.226C67.2822 184.364 65.5461 178.371 63.5486 172.497C62.3782 169.05 59.5848 165.628 58.313 162.137C55.0007 151.537 52.9837 145.021 47.1551 135.472C43.5658 145.135 39.2704 153.769 37.2261 164.04C36.2742 168.814 36.8828 174.017 36.0947 178.67C34.3781 186.337 33.4846 193.133 32.8448 200.899C32.4079 206.212 30.9137 207.824 31.2765 214.027C29.6691 215.375 28.3582 216.437 26.6494 217.662C24.1487 218.028 19.6582 218.262 17.2472 217.448C14.9141 214.397 19.4865 209.857 20.021 206.666C20.376 204.543 19.8611 202.068 20.1771 199.986C21.6362 190.603 21.4255 181.195 21.9366 171.751C22.1629 167.566 23.899 162.747 24.4179 158.528C24.6949 157.119 24.8392 155.68 25.0928 154.268C26.1813 148.745 25.4049 143.155 25.6897 137.601C26.0604 130.31 27.2464 123.095 27.1684 115.739C27.1449 113.678 30.9995 110.307 31.3584 107.963C31.9241 104.269 32.1816 100.554 32.6264 96.8437L35.6811 71.7792L32.9307 69.2579C26.8016 69.4967 20.6024 69.7483 15.3277 66.447C14.0481 63.39 13.377 61.4695 12.3119 58.3157C10.8606 54.0326 10.4003 48.0523 8.11409 44.5235C6.40529 41.8836 1.56368 39.0044 0.0499494 37.3093C-0.184133 35.8295 0.455673 34.271 0.908231 32.8012C3.71331 30.0759 9.99453 25.45 13.9427 24.4547C14.879 24.2185 16.6503 24.246 17.7622 23.4428C22.6935 19.8851 28.924 15.5752 33.59 11.9387C37.4875 8.89917 46.9405 2.94942 49.7027 0Z"
            fill="currentColor"
          />
        </svg>

        {/* Pose 3: Impact */}
        <svg
          viewBox="0 0 82 191"
          className="swing-pose-3 absolute inset-0 w-full h-full"
          preserveAspectRatio="xMidYMid meet"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            d="M22.738 63.1419C19.8022 55.7636 16.417 49.806 15.8638 41.6602C15.4432 35.4664 21.9054 32.3387 22.5749 28.7097C21.1774 27.6531 18.3552 29.2809 18.0282 26.5999C17.6911 24.3236 18.5389 21.7734 18.4796 19.5677C18.1199 15.0674 17.3229 11.949 18.1371 7.46899C19.4585 0.197578 31.8742 -2.27148 36.248 2.33343C41.5999 7.96842 38.7172 10.6759 46.9264 14.9917C52.8534 14.7303 61.459 13.6584 66.0431 18.0733C70.2867 22.1597 72.235 34.0091 72.8182 39.9063C73.0476 42.2271 70.9717 43.7609 71.1582 45.1558C71.9954 51.4049 73.1694 57.7169 74.2044 63.943C74.6109 66.3875 74.957 71.1485 75.6214 73.0947C77.1718 77.1557 79.8653 79.9244 80.8375 84.2745C81.4313 86.9297 80.3717 89.4195 80.6721 91.53C82.3883 103.596 80.5418 114.881 79.9273 126.876C79.5727 133.796 81.7356 141.573 81.1387 148.611C80.6116 154.687 80.2437 160.98 79.6312 167.036C79.3394 169.919 79.6885 177.934 79.1275 180.099C77.4453 186.584 76.45 182.819 78.4035 190.458H66.1383C64.8431 187.13 65.4712 171.059 65.2832 166.681C65.074 161.8 64.4502 156.158 64.3667 151.218C64.0847 149.708 65.2601 142.486 64.9188 141.537C63.0851 136.453 63.0996 131.678 62.7426 126.349C62.4164 121.483 61.2109 116.939 59.822 112.336C58.5111 114.539 56.7953 116.415 56.0209 118.919C50.1142 138.014 46.9584 157.96 41.6713 177.239C40.7919 180.446 39.6258 187.871 38.2178 190.458H37.0876C36.7056 187.38 51.4267 125.793 53.137 116.338L50.399 112.567L30.3382 158.448C26.8153 166.314 23.0555 174.11 19.636 182.034C17.7848 186.322 19.8505 187.934 15.4022 190.458H0C0.811094 185.382 5.3722 183.185 7.13054 178.554C11.3167 167.52 13.5631 155.83 17.3119 144.608C19.0496 139.473 22.2854 135.81 24.3921 130.776C26.9222 124.735 26.5293 117.257 28.0091 111.506C29.9005 104.158 30.7931 88.7273 33.519 82.5558C31.3331 77.9513 30.339 72.8762 28.1094 68.2853C27.6502 67.3399 27.1664 66.4007 26.7451 65.4389C25.4264 64.682 24.0644 63.8716 22.738 63.1419Z"
            fill="currentColor"
          />
        </svg>

        {/* Pose 4: Follow-through — viewBox shifted left so torso is centered */}
        <svg
          viewBox="-46 0 202 191"
          className="swing-pose-4 absolute inset-0 w-full h-full"
          preserveAspectRatio="xMidYMid meet"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            d="M195.776 11.677C195.054 8.33824 193.127 2.2046 196.986 0.0305122C203.438 -0.57739 202.393 8.05382 199.568 12.036C176.203 23.5288 152.978 35.2373 129.781 47.0777C127.982 47.9966 128.489 49.4723 127.389 50.5734C125.653 52.3198 122.348 54.529 120.105 55.5993C117.515 56.8319 112.291 59.0111 109.47 58.0438C107.555 57.3863 105.362 55.1131 103.388 53.7467C96.0377 56.0945 84.1541 56.5517 76.5152 55.396C79.4998 61.5293 80.7521 69.2623 80.955 76.0151C84.8759 82.1156 84.673 83.8219 85.9058 90.5427C88.192 103.043 86.4598 112.286 85.4728 124.517C84.3336 138.668 82.9954 153.16 82.3244 167.358C82.2698 169.895 81.2632 173.863 81.1033 176.645C80.8419 181.175 80.7717 185.869 80.9706 190.395H67.113C66.0323 180.18 65.5524 169.91 65.6811 159.637C65.845 146.355 68.533 134.54 64.5068 121.064C61.6003 126.853 58.9747 134.279 55.3776 139.566C52.5257 143.756 47.1575 149.137 43.6072 153.156C37.5016 160.07 28.3529 173.414 21.9273 179.079C20.8427 179.325 20.476 178.912 19.2588 178.408C17.0272 182.326 14.9361 186.325 12.9893 190.395H0.0679752C-0.329964 185.791 1.13303 184.741 1.51146 181.058C2.33855 172.981 0.259121 170.109 9.65361 168.045C11.6238 166.075 15.5993 162.185 17.0584 160.07C24.5997 149.133 28.2085 139.874 39.4913 131.735C43.26 121.739 44.9064 104.871 43.6658 94.2139C42.8582 87.28 43.022 85.4419 45.3043 78.6488C43.8296 74.607 43.4316 68.8662 42.1325 65.8267C38.4769 57.2794 32.8317 51.3963 31.1307 41.7268C30.0617 36.1773 32.1489 30.0967 30.9707 24.5643C29.5584 17.9609 25.4503 12.4106 28.6845 5.48642C31.0409 0.447628 38.867 -0.663599 43.4355 1.6412C46.8492 3.36229 48.8194 6.88093 50.2668 10.2935C59.6964 13.1133 64.183 17.2711 71.7907 23.2377C72.9845 24.1761 74.0691 25.6908 75.2083 26.7279C78.9419 30.2251 84.5559 30.9773 89.0308 33.3563C93.693 35.8351 99.584 41.7506 104.531 43.0405C112.872 45.2162 117.218 41.4237 125.594 46.0832C149.116 34.8788 172.512 23.4094 195.776 11.677ZM72.5944 43.1783C75.1458 43.6329 80.2255 44.684 82.6638 44.3406C81.0213 43.188 72.3564 38.1235 70.71 37.5558C71.0611 39.9171 71.3576 41.0986 72.5944 43.1783Z"
            fill="currentColor"
          />
        </svg>
      </div>

      {/* Title */}
      <h3 className="text-xl font-semibold mb-6">Analyzing Your Swing</h3>

      {/* Pipeline progress steps */}
      <div className="space-y-2.5 text-sm w-56 mx-auto text-left">
        {PIPELINE_STEPS.map((step, i) => {
          const isComplete = i < activeStep;
          const isActive = i === activeStep;

          return (
            <div key={step.label} className="flex items-center gap-3">
              {/* Step indicator */}
              {isComplete ? (
                <svg
                  className="w-4 h-4 text-forest-green shrink-0"
                  fill="currentColor"
                  viewBox="0 0 20 20"
                >
                  <path
                    fillRule="evenodd"
                    d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z"
                    clipRule="evenodd"
                  />
                </svg>
              ) : (
                <div className={`w-1.5 h-1.5 rounded-full shrink-0 mx-[5px] ${isActive ? "bg-pastel-yellow" : "bg-cream/15"}`} />
              )}

              {/* Step label */}
              <span
                className={`whitespace-nowrap ${
                  isComplete
                    ? "text-cream/40"
                    : isActive
                      ? "text-cream/70"
                      : "text-cream/25"
                }`}
              >
                {step.label}
                {isActive && (
                  <span className="loading-ellipsis" />
                )}
              </span>
            </div>
          );
        })}
      </div>

      {/* Duration hint */}
      <p className="mt-6 text-xs text-cream/30">This usually takes 15–25 seconds</p>

      {/* Error display */}
      {analysisError && (
        <div className="mt-6 rounded-lg border border-cardinal-red/50 bg-cardinal-red/5 p-4">
          <p className="text-sm text-cardinal-red">{analysisError}</p>
        </div>
      )}
    </div>
  );
}
